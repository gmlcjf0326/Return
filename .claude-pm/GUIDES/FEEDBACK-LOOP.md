# 🔄 피드백 루프 & 자가 검증 가이드

> Claude Code가 **스스로 체크하고, 검증하고, 수정**하는 구조

---

## 🎯 핵심 원칙

```
"작성 → 검증 → 수정" 사이클을 항상 돌린다

❌ Bad: 코드 작성 → 다음 태스크
✅ Good: 코드 작성 → 테스트 → 검증 → 문제있으면 수정 → 다음 태스크
```

---

## 🔄 피드백 루프 구조

### 전체 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐  │
│   │  계획   │ ──→ │  구현   │ ──→ │  검증   │ ──→ │  완료   │  │
│   └─────────┘     └─────────┘     └─────────┘     └─────────┘  │
│                         │               │                       │
│                         │      ❌ 실패   │                       │
│                         │               │                       │
│                         └───────────────┘                       │
│                              피드백 루프                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 단계별 피드백 루프

```
Level 1: 함수/메서드 레벨
┌──────────────────────────────────────────────┐
│ 함수 작성 → 단위 테스트 → 통과? → 다음 함수  │
│                  ↓ 실패                       │
│              수정 후 재테스트                 │
└──────────────────────────────────────────────┘

Level 2: API/기능 레벨  
┌──────────────────────────────────────────────┐
│ API 구현 → curl 테스트 → 통과? → 다음 API   │
│                  ↓ 실패                       │
│              디버깅 후 재테스트              │
└──────────────────────────────────────────────┘

Level 3: 태스크 레벨
┌──────────────────────────────────────────────┐
│ 태스크 구현 → 통합 테스트 → 통과? → 완료    │
│                    ↓ 실패                    │
│                문제 파악 후 수정             │
└──────────────────────────────────────────────┘

Level 4: 시스템 레벨
┌──────────────────────────────────────────────┐
│ 전체 빌드 → E2E 테스트 → 통과? → 배포 준비  │
│                   ↓ 실패                     │
│               원인 분석 후 수정              │
└──────────────────────────────────────────────┘
```

---

## ✅ 자가 검증 체크리스트

### 함수 작성 후 (즉시)

```markdown
□ 함수가 한 가지 일만 하는가?
□ 에러 케이스를 처리했는가?
□ edge case를 고려했는가?
□ 직접 실행해서 동작 확인했는가?

# 확인 방법
console.log() 또는 간단한 테스트 코드로 즉시 확인
```

### API 엔드포인트 작성 후 (즉시)

```markdown
□ curl로 정상 케이스 테스트했는가?
□ 에러 케이스 테스트했는가? (최소 2개)
□ 응답 형식이 일관적인가?
□ 상태 코드가 적절한가?

# 확인 방법 (즉시 실행)
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"test123"}'
```

### 파일 작성 후

```markdown
□ 문법 에러 없는가? (lint 통과)
□ import가 모두 유효한가?
□ 서버 재시작 후 에러 없는가?

# 확인 방법
npm run lint
npm run dev (서버 시작해서 에러 확인)
```

### 서브태스크 완료 후

```markdown
□ 기능이 의도대로 동작하는가?
□ 관련 기존 기능이 깨지지 않았는가?
□ 콘솔에 에러/경고가 없는가?
□ PROGRESS.md에 체크했는가?
```

### 태스크 완료 후

```markdown
□ 모든 서브태스크가 완료되었는가?
□ 통합 테스트를 통과했는가?
□ 코드 리뷰를 했는가? (/review)
□ 문서를 업데이트했는가?
□ 다음 태스크와 연결되는가?
```

---

## 🔍 검증 자동화

### 1. 코드 작성 직후 자동 체크

```javascript
// 함수 작성 후 바로 테스트 코드 작성
function calculateTotal(items) {
  return items.reduce((sum, item) => sum + item.price * item.qty, 0);
}

// 즉시 검증
console.log('=== 자가 테스트 ===');
console.log('빈 배열:', calculateTotal([])); // 예상: 0
console.log('단일 아이템:', calculateTotal([{price: 100, qty: 2}])); // 예상: 200
console.log('복수 아이템:', calculateTotal([
  {price: 100, qty: 2},
  {price: 50, qty: 3}
])); // 예상: 350
```

### 2. API 작성 후 자동 테스트 스크립트

```bash
#!/bin/bash
# scripts/test-api.sh

echo "=== API 자가 테스트 ==="

# 1. 회원가입 테스트
echo "\n[1] 회원가입 테스트"
RESULT=$(curl -s -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"test123","name":"테스트"}')
echo $RESULT | jq .

# 2. 로그인 테스트
echo "\n[2] 로그인 테스트"
RESULT=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"test123"}')
echo $RESULT | jq .
TOKEN=$(echo $RESULT | jq -r '.data.token')

# 3. 인증 필요 API 테스트
echo "\n[3] 인증 API 테스트"
curl -s http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer $TOKEN" | jq .

echo "\n=== 테스트 완료 ==="
```

### 3. 변경 후 자동 검증

```javascript
// package.json
{
  "scripts": {
    "dev": "nodemon src/index.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "lint": "eslint src/",
    "check": "npm run lint && npm test"  // 커밋 전 체크
  }
}
```

---

## 📋 피드백 루프 템플릿

### 구현 중 체크 템플릿

```markdown
## [함수명/API명] 구현

### 작성 내용
- 파일: src/services/userService.js
- 함수: createUser()

### 자가 테스트
```bash
# 테스트 명령어
node -e "const {createUser} = require('./src/services/userService'); ..."
```

### 테스트 결과
- [ ] 정상 케이스: ✅/❌
- [ ] 에러 케이스 1: ✅/❌
- [ ] 에러 케이스 2: ✅/❌

### 발견된 문제
- (있으면 기록)

### 수정 사항
- (수정했으면 기록)

### 최종 확인
- [ ] 모든 테스트 통과
```

---

## 🚨 문제 발견 시 대응

### 즉시 대응 원칙

```
문제 발견 → 즉시 기록 → 원인 분석 → 수정 → 재검증

❌ Bad: 문제 발견 → 나중에 하자 → 잊어버림
✅ Good: 문제 발견 → 바로 수정 → 확인 후 진행
```

### 문제 기록 형식

```markdown
## 🐛 발견된 문제

### 문제
- 위치: src/controllers/authController.js:45
- 증상: 중복 이메일 체크가 안 됨
- 에러: 500 Internal Server Error

### 원인
- User.findOne() 결과를 await 안 함

### 수정
```javascript
// Before
const user = User.findOne({ email });

// After  
const user = await User.findOne({ email });
```

### 재검증
- [x] 수정 후 테스트 통과 확인
```

---

## 🔁 지속적 모니터링

### 구현 중 모니터링 항목

```markdown
□ 서버 콘솔에 에러 없는가?
□ 브라우저 콘솔에 에러 없는가?
□ 네트워크 요청이 실패하지 않는가?
□ 메모리 누수 징후가 없는가?
□ 응답 시간이 적절한가?
```

### 터미널 분할 사용

```
┌─────────────────┬─────────────────┐
│                 │                 │
│   서버 로그     │   작업 터미널   │
│   (실시간)      │                 │
│                 │                 │
├─────────────────┼─────────────────┤
│                 │                 │
│   테스트 결과   │   DB 쿼리 로그  │
│                 │                 │
│                 │                 │
└─────────────────┴─────────────────┘

서버 로그를 항상 켜두고, 에러 발생 즉시 확인!
```

---

## 📊 품질 게이트

### 서브태스크 완료 전 게이트

```markdown
## 품질 게이트 체크

### 필수 (하나라도 실패하면 완료 불가)
- [ ] 코드가 실행되는가?
- [ ] 기본 기능이 동작하는가?
- [ ] 명백한 버그가 없는가?

### 권장 (가능하면 통과)
- [ ] 에러 핸들링이 있는가?
- [ ] 테스트 코드가 있는가?
- [ ] 코드 스타일이 일관적인가?
```

### 태스크 완료 전 게이트

```markdown
## 태스크 완료 게이트

### 기능 검증
- [ ] 모든 요구사항 충족
- [ ] 정상 시나리오 동작
- [ ] 에러 시나리오 처리

### 코드 품질
- [ ] /review 통과
- [ ] lint 에러 없음
- [ ] 테스트 통과

### 문서화
- [ ] PROGRESS.md 업데이트
- [ ] 필요시 API.md 업데이트
- [ ] 주석 추가 (복잡한 로직)
```

### Phase 완료 전 게이트

```markdown
## Phase 완료 게이트

### 통합 검증
- [ ] 모든 태스크 완료
- [ ] 태스크 간 연동 테스트
- [ ] E2E 테스트 (주요 시나리오)

### 품질 검증
- [ ] 전체 테스트 통과
- [ ] 성능 이슈 없음
- [ ] 보안 취약점 없음

### 문서 검증
- [ ] ARCHITECTURE.md 최신화
- [ ] API 문서 완성
- [ ] README 업데이트
```

---

## 🎯 Claude Code 자동 체크 규칙

### CLAUDE.md에 추가할 내용

```markdown
## 🔄 피드백 루프 규칙

### 코드 작성 후 (자동)
1. 문법 에러 확인 (lint)
2. 기본 동작 테스트
3. 에러 케이스 테스트

### 서브태스크 완료 전 (자동)
1. 품질 게이트 체크
2. 관련 테스트 실행
3. PROGRESS.md 업데이트

### 태스크 완료 전 (자동)
1. /review 실행
2. 통합 테스트
3. 문서 업데이트

### 문제 발견 시 (자동)
1. 즉시 기록
2. 원인 분석
3. 수정 후 재검증
```

---

## ✅ 요약: 피드백 루프 체크포인트

```
📍 함수 작성 → 즉시 테스트 → 통과? → 다음
                    ↓ 실패
                  수정 후 재테스트

📍 API 작성 → curl 테스트 → 통과? → 다음
                    ↓ 실패
                  디버깅 후 재테스트

📍 서브태스크 → 품질 게이트 → 통과? → 체크 표시
                    ↓ 실패
                  수정 후 재검증

📍 태스크 → 통합 테스트 → 통과? → 완료 ✅
                    ↓ 실패
                  문제 해결 후 재테스트

📍 Phase → E2E 테스트 → 통과? → 다음 Phase
                    ↓ 실패
                  전체 점검 후 수정
```

**핵심: "작성했으면 바로 테스트, 실패하면 바로 수정!"**
