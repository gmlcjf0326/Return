// ReMemory - AI 기반 회상치료 플랫폼
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 세션 (인증 없음 - UUID 기반)
model Session {
  id            String    @id @default(uuid())
  nickname      String?
  birthYear     Int?      @map("birth_year")
  profileData   String?   @map("profile_data")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastActiveAt  DateTime? @map("last_active_at")

  assessments       Assessment[]
  trainingSessions  TrainingSession[]
  photos            Photo[]
  reminiscenceLogs  ReminiscenceLog[]

  @@map("sessions")
}

// 진단 결과
model Assessment {
  id              Int      @id @default(autoincrement())
  sessionId       String   @map("session_id")
  totalScore      Int?     @map("total_score")
  memoryScore     Int?     @map("memory_score")
  calculationScore Int?    @map("calculation_score")
  languageScore   Int?     @map("language_score")
  attentionScore  Int?     @map("attention_score")
  executiveScore  Int?     @map("executive_score")
  visuospatialScore Int?   @map("visuospatial_score")
  riskLevel       String?  @map("risk_level")
  behaviorData    String?  @map("behavior_data")
  rawResponses    String?  @map("raw_responses")
  createdAt       DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

// 훈련 기록
model TrainingSession {
  id              Int      @id @default(autoincrement())
  sessionId       String   @map("session_id")
  trainingType    String   @map("training_type")
  durationSeconds Int?     @map("duration_seconds")
  engagementScore Int?     @map("engagement_score")
  completionRate  Float?   @map("completion_rate")
  performanceData String?  @map("performance_data")
  createdAt       DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("training_sessions")
}

// 사진 + 자동 태깅
model Photo {
  id              Int      @id @default(autoincrement())
  sessionId       String   @map("session_id")
  fileUrl         String?  @map("file_url")
  fileName        String?  @map("file_name")

  // AI 자동 태깅 결과
  autoTags        String?  @map("auto_tags")
  sceneType       String?  @map("scene_type")
  estimatedEra    String?  @map("estimated_era")
  peopleCount     Int?     @map("people_count")
  mood            String?

  // 사용자 수정/추가 태그
  userTags        String?  @map("user_tags")
  userDescription String?  @map("user_description")

  createdAt       DateTime @default(now()) @map("created_at")

  session          Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  reminiscenceLogs ReminiscenceLog[]

  @@map("photos")
}

// 회상 대화 기록
model ReminiscenceLog {
  id               Int      @id @default(autoincrement())
  sessionId        String   @map("session_id")
  photoId          Int?     @map("photo_id")
  aiQuestion       String?  @map("ai_question")
  userResponse     String?  @map("user_response")
  responseAnalysis String?  @map("response_analysis")
  createdAt        DateTime @default(now()) @map("created_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  photo   Photo?  @relation(fields: [photoId], references: [id], onDelete: SetNull)

  @@map("reminiscence_logs")
}
